{% extends "base.html" %}

{% block title %}Especialidades - Cl√≠nica Est√©tica{% endblock %}
{% block page_title %}Gerenciar Especialidades{% endblock %}

{% block content %}
<div class="specialties-page">
    <!-- Barra de A√ß√µes -->
    <div class="action-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar especialidades...">
        </div>
        <button class="btn btn-primary" onclick="openSpecialtyModal()">
            <i class="fas fa-plus"></i>
            Nova Especialidade
        </button>
    </div>
    
    <!-- Tabela de Especialidades -->
    <div class="card">
        <div class="table-responsive">
            <table class="table" id="specialtiesTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Descri√ß√£o</th>
                        <th>Profissionais</th>
                        <th>Status</th>
                        <th>Criado em</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="specialtiesTableBody">
                    <tr>
                        <td colspan="6" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Carregando especialidades...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagina√ß√£o -->
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Modal de Especialidade -->
<div class="modal" id="specialtyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Nova Especialidade</h2>
            <button class="modal-close" onclick="closeSpecialtyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="specialtyForm" class="modal-form">
            <input type="hidden" id="specialtyId">
            
            <div class="form-group">
                <label for="name">
                    <i class="fas fa-stethoscope"></i>
                    Nome da Especialidade *
                </label>
                <input type="text" id="name" name="name" required placeholder="Ex: Dermatologia, Est√©tica Facial...">
            </div>
            
            <div class="form-group">
                <label for="description">
                    <i class="fas fa-file-text"></i>
                    Descri√ß√£o
                </label>
                <textarea id="description" name="description" rows="4" 
                          placeholder="Descri√ß√£o detalhada da especialidade..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="checkbox-container">
                    <input type="checkbox" id="is_active" name="is_active" checked>
                    <span class="checkmark"></span>
                    Especialidade ativa
                </label>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSpecialtyModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPage = 1;
let searchTimeout;

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üè• Inicializando p√°gina de especialidades');
    loadSpecialties();
    
    // Configurar busca
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadSpecialties();
        }, 500);
    });
    
    // Configurar formul√°rio
    document.getElementById('specialtyForm').addEventListener('submit', handleSpecialtySubmit);
});

// Carregar especialidades
async function loadSpecialties(page = 1) {
    console.log(`üìã Carregando especialidades - P√°gina ${page}`);
    const search = document.getElementById('searchInput').value;
    const url = `/professionals/api/specialties/list?page=${page}&search=${encodeURIComponent(search)}`;
    
    try {
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Especialidades carregadas:', data);
        
        renderSpecialties(data.specialties);
        renderPagination(data);
        currentPage = page;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar especialidades:', error);
        showToast('Erro ao carregar especialidades: ' + error.message, 'error');
        
        document.getElementById('specialtiesTableBody').innerHTML = 
            `<tr><td colspan="6" class="text-center" style="color: #f44336;">
                <i class="fas fa-exclamation-triangle"></i> 
                Erro ao carregar especialidades: ${error.message}
            </td></tr>`;
    }
}

// Renderizar tabela
function renderSpecialties(specialties) {
    const tbody = document.getElementById('specialtiesTableBody');
    
    if (specialties.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center" style="color: #666;">
                    <i class="fas fa-stethoscope" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                    Nenhuma especialidade encontrada
                </td>
            </tr>`;
        return;
    }
    
    tbody.innerHTML = specialties.map(specialty => {
        const createdDate = new Date(specialty.created_at);
        const statusClass = specialty.is_active ? 'success' : 'danger';
        const statusText = specialty.is_active ? 'Ativa' : 'Inativa';
        const statusIcon = specialty.is_active ? 'check-circle' : 'times-circle';
        
        return `
            <tr>
                <td><strong>${specialty.name}</strong></td>
                <td>${specialty.description || '<em>-</em>'}</td>
                <td>
                    <span class="badge badge-info">
                        <i class="fas fa-user-md"></i> 
                        ${specialty.professionals_count || 0}
                    </span>
                </td>
                <td>
                    <span class="status-badge status-${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        ${statusText}
                    </span>
                </td>
                <td>${createdDate.toLocaleDateString('pt-BR')}</td>
                <td>
                    <button class="btn-icon" onclick="editSpecialty(${specialty.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon danger" onclick="deleteSpecialty(${specialty.id})" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Renderizar pagina√ß√£o
function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    
    if (data.pages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Bot√£o anterior
    html += `<button onclick="loadSpecialties(${data.current_page - 1})" 
                    ${data.current_page === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;
    
    // P√°ginas
    const startPage = Math.max(1, data.current_page - 2);
    const endPage = Math.min(data.pages, data.current_page + 2);
    
    if (startPage > 1) {
        html += `<button onclick="loadSpecialties(1)">1</button>`;
        if (startPage > 2) html += `<span>...</span>`;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="loadSpecialties(${i})" 
                        class="${i === data.current_page ? 'active' : ''}">${i}</button>`;
    }
    
    if (endPage < data.pages) {
        if (endPage < data.pages - 1) html += `<span>...</span>`;
        html += `<button onclick="loadSpecialties(${data.pages})">${data.pages}</button>`;
    }
    
    // Bot√£o pr√≥ximo
    html += `<button onclick="loadSpecialties(${data.current_page + 1})" 
                    ${data.current_page === data.pages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;
    
    pagination.innerHTML = html;
}

// Modal functions
function openSpecialtyModal() {
    console.log('‚ûï Abrindo modal para nova especialidade');
    document.getElementById('modalTitle').textContent = 'Nova Especialidade';
    document.getElementById('specialtyForm').reset();
    document.getElementById('specialtyId').value = '';
    document.getElementById('is_active').checked = true;
    document.getElementById('specialtyModal').classList.add('active');
    
    setTimeout(() => {
        document.getElementById('name').focus();
    }, 300);
}

function closeSpecialtyModal() {
    document.getElementById('specialtyModal').classList.remove('active');
}

// Editar especialidade
async function editSpecialty(id) {
    console.log(`‚úèÔ∏è Editando especialidade ID: ${id}`);
    
    try {
        const response = await fetch(`/professionals/api/specialties/${id}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const specialty = await response.json();
        console.log('‚úÖ Dados da especialidade carregados:', specialty);
        
        document.getElementById('modalTitle').textContent = 'Editar Especialidade';
        document.getElementById('specialtyId').value = specialty.id;
        document.getElementById('name').value = specialty.name;
        document.getElementById('description').value = specialty.description || '';
        document.getElementById('is_active').checked = specialty.is_active;
        
        document.getElementById('specialtyModal').classList.add('active');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados da especialidade:', error);
        showToast('Erro ao carregar dados da especialidade: ' + error.message, 'error');
    }
}

// Salvar especialidade
async function handleSpecialtySubmit(e) {
    e.preventDefault();
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const specialtyId = document.getElementById('specialtyId').value;
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            is_active: document.getElementById('is_active').checked
        };
        
        console.log('üíæ Salvando especialidade:', data);
        
        const url = specialtyId ? `/professionals/api/specialties/${specialtyId}` : '/professionals/api/specialties/create';
        const method = specialtyId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('‚úÖ Especialidade salva com sucesso:', result);
        showToast(result.message, 'success');
        closeSpecialtyModal();
        loadSpecialties(currentPage);
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar especialidade:', error);
        showToast(error.message, 'error');
    } finally {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
}

// Excluir especialidade
async function deleteSpecialty(id) {
    const specialty = await getSpecialtyById(id);
    const specialtyName = specialty ? specialty.name : 'esta especialidade';
    
    if (!confirm(`Tem certeza que deseja excluir ${specialtyName}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
    }
    
    console.log(`üóëÔ∏è Excluindo especialidade ID: ${id}`);
    
    try {
        const response = await fetch(`/professionals/api/specialties/${id}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('‚úÖ Especialidade exclu√≠da com sucesso');
        showToast(result.message, 'success');
        loadSpecialties(currentPage);
        
    } catch (error) {
        console.error('‚ùå Erro ao excluir especialidade:', error);
        showToast('Erro ao excluir especialidade: ' + error.message, 'error');
    }
}

// Buscar especialidade por ID
async function getSpecialtyById(id) {
    try {
        const response = await fetch(`/professionals/api/specialties/${id}`);
        return response.ok ? await response.json() : null;
    } catch {
        return null;
    }
}

// Fechar modal ao clicar fora
document.getElementById('specialtyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSpecialtyModal();
    }
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSpecialtyModal();
    }
    
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openSpecialtyModal();
    }
});
</script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.status-success {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-danger {
    background: #ffebee;
    color: #c62828;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-info {
    background: #e3f2fd;
    color: #1565c0;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 0;
}

.checkbox-container input[type="checkbox"] {
    margin: 0;
}
</style>
{% endblock %}