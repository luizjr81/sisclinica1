{% extends "base.html" %}

{% block title %}Pacientes - Clínica Estética{% endblock %}
{% block page_title %}Gerenciar Pacientes{% endblock %}

{% block content %}
<div class="patients-page">
    <!-- Barra de Ações -->
    <div class="action-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar por nome, CPF ou telefone...">
        </div>
        <button class="btn btn-primary" onclick="openPatientModal()">
            <i class="fas fa-plus"></i>
            Novo Paciente
        </button>
    </div>
    
    <!-- Tabela de Pacientes -->
    <div class="card">
        <div class="table-responsive">
            <table class="table" id="patientsTable">
                <thead>
                    <tr>
                        <th>Nome Completo</th>
                        <th>CPF</th>
                        <th>Data Nascimento</th>
                        <th>Telefone</th>
                        <th>Gosto Musical</th>
                        <th>Cadastro</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Carregando pacientes...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Paginação -->
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Modal de Paciente -->
<div class="modal" id="patientModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Novo Paciente</h2>
            <button class="modal-close" onclick="closePatientModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="patientForm" class="modal-form">
            <input type="hidden" id="patientId">
            
            <div class="form-row">
                <div class="form-group flex-2">
                    <label for="full_name">
                        <i class="fas fa-user"></i>
                        Nome Completo *
                    </label>
                    <input type="text" id="full_name" name="full_name" required>
                </div>
                
                <div class="form-group">
                    <label for="cpf">
                        <i class="fas fa-id-card"></i>
                        CPF *
                    </label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="birth_date">
                        <i class="fas fa-calendar"></i>
                        Data de Nascimento *
                    </label>
                    <input type="date" id="birth_date" name="birth_date" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">
                        <i class="fas fa-phone"></i>
                        Telefone *
                    </label>
                    <input type="text" id="phone" name="phone" placeholder="(00) 00000-0000" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="musical_preference">
                    <i class="fas fa-music"></i>
                    Gosto Musical
                </label>
                <input type="text" id="musical_preference" name="musical_preference" 
                       placeholder="Ex: MPB, Rock, Clássica...">
            </div>
            
            <div class="form-group">
                <label for="observations">
                    <i class="fas fa-notes-medical"></i>
                    Observações
                </label>
                <textarea id="observations" name="observations" rows="4" 
                          placeholder="Informações adicionais sobre o paciente..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePatientModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPage = 1;
let searchTimeout;

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
    
    // Configurar busca
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadPatients();
        }, 500);
    });
    
    // Configurar formulário
    document.getElementById('patientForm').addEventListener('submit', handlePatientSubmit);
    
    // Máscaras
    setupMasks();
});

// Carregar pacientes
function loadPatients(page = 1) {
    const search = document.getElementById('searchInput').value;
    const url = `/patients/api/list?page=${page}&search=${search}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            renderPatients(data.patients);
            renderPagination(data);
        })
        .catch(error => {
            console.error('Erro ao carregar pacientes:', error);
            showAlert('Erro ao carregar pacientes', 'error');
        });
}

// Renderizar tabela
function renderPatients(patients) {
    const tbody = document.getElementById('patientsTableBody');
    
    if (patients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum paciente encontrado</td></tr>';
        return;
    }
    
    tbody.innerHTML = patients.map(patient => {
        const birthDate = new Date(patient.birth_date);
        const age = calculateAge(birthDate);
        
        return `
            <tr>
                <td>${patient.full_name}</td>
                <td>${patient.cpf}</td>
                <td>${birthDate.toLocaleDateString('pt-BR')} (${age} anos)</td>
                <td>${patient.phone}</td>
                <td>${patient.musical_preference || '-'}</td>
                <td>${new Date(patient.created_at).toLocaleDateString('pt-BR')}</td>
                <td>
                    <button class="btn-icon" onclick="editPatient(${patient.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon danger" onclick="deletePatient(${patient.id})" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Renderizar paginação
function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    let html = '';
    
    if (data.pages > 1) {
        html += `<button onclick="loadPatients(${data.current_page - 1})" 
                        ${data.current_page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>`;
        
        for (let i = 1; i <= data.pages; i++) {
            html += `<button onclick="loadPatients(${i})" 
                            class="${i === data.current_page ? 'active' : ''}">${i}</button>`;
        }
        
        html += `<button onclick="loadPatients(${data.current_page + 1})" 
                        ${data.current_page === data.pages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>`;
    }
    
    pagination.innerHTML = html;
}

// Modal functions
function openPatientModal() {
    document.getElementById('modalTitle').textContent = 'Novo Paciente';
    document.getElementById('patientForm').reset();
    document.getElementById('patientId').value = '';
    document.getElementById('patientModal').classList.add('active');
}

function closePatientModal() {
    document.getElementById('patientModal').classList.remove('active');
}

// Editar paciente
function editPatient(id) {
    fetch(`/patients/api/${id}`)
        .then(response => response.json())
        .then(patient => {
            document.getElementById('modalTitle').textContent = 'Editar Paciente';
            document.getElementById('patientId').value = patient.id;
            document.getElementById('full_name').value = patient.full_name;
            document.getElementById('cpf').value = patient.cpf;
            document.getElementById('birth_date').value = patient.birth_date;
            document.getElementById('phone').value = patient.phone;
            document.getElementById('musical_preference').value = patient.musical_preference || '';
            document.getElementById('observations').value = patient.observations || '';
            
            document.getElementById('patientModal').classList.add('active');
        })
        .catch(error => {
            console.error('Erro ao carregar paciente:', error);
            showAlert('Erro ao carregar dados do paciente', 'error');
        });
}

// Salvar paciente
function handlePatientSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const patientId = document.getElementById('patientId').value;
    const data = Object.fromEntries(formData);
    
    const url = patientId ? `/patients/api/${patientId}` : '/patients/api/create';
    const method = patientId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showAlert(result.error, 'error');
        } else {
            showAlert(result.message, 'success');
            closePatientModal();
            loadPatients(currentPage);
        }
    })
    .catch(error => {
        console.error('Erro ao salvar paciente:', error);
        showAlert('Erro ao salvar paciente', 'error');
    });
}

// Excluir paciente
function deletePatient(id) {
    if (!confirm('Tem certeza que deseja excluir este paciente?')) {
        return;
    }
    
    fetch(`/patients/api/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                showAlert(result.error, 'error');
            } else {
                showAlert(result.message, 'success');
                loadPatients(currentPage);
            }
        })
        .catch(error => {
            console.error('Erro ao excluir paciente:', error);
            showAlert('Erro ao excluir paciente', 'error');
        });
}

// Máscaras
function setupMasks() {
    // CPF
    document.getElementById('cpf').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        e.target.value = value;
    });
    
    // Telefone
    document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            if (value.length === 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            }
        }
        e.target.value = value;
    });
}

// Utilitários
function calculateAge(birthDate) {
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    return age;
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.querySelector('.content-wrapper').insertBefore(alertDiv, document.querySelector('.content-wrapper').firstChild);
    
    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}