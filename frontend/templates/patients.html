{% extends "base.html" %}

{% block title %}Pacientes - Cl√≠nica Est√©tica{% endblock %}
{% block page_title %}Gerenciar Pacientes{% endblock %}

{% block content %}
<div class="patients-page">
    <!-- Barra de A√ß√µes -->
    <div class="action-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar por nome, CPF ou telefone...">
        </div>
        <button class="btn btn-primary" onclick="openPatientModal()">
            <i class="fas fa-plus"></i>
            Novo Paciente
        </button>
    </div>
    
    <!-- Tabela de Pacientes -->
    <div class="card">
        <div class="table-responsive">
            <table class="table" id="patientsTable">
                <thead>
                    <tr>
                        <th>Nome Completo</th>
                        <th>CPF</th>
                        <th>Data Nascimento</th>
                        <th>Telefone</th>
                        <th>Gosto Musical</th>
                        <th>Cadastro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Carregando pacientes...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagina√ß√£o -->
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Modal de Paciente -->
<div class="modal" id="patientModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Novo Paciente</h2>
            <button class="modal-close" onclick="closePatientModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="patientForm" class="modal-form">
            <input type="hidden" id="patientId">
            
            <div class="form-row">
                <div class="form-group flex-2">
                    <label for="full_name">
                        <i class="fas fa-user"></i>
                        Nome Completo *
                    </label>
                    <input type="text" id="full_name" name="full_name" required>
                </div>
                
                <div class="form-group">
                    <label for="cpf">
                        <i class="fas fa-id-card"></i>
                        CPF *
                    </label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="birth_date">
                        <i class="fas fa-calendar"></i>
                        Data de Nascimento
                    </label>
                    <input type="date" id="birth_date" name="birth_date">
                </div>
                
                <div class="form-group">
                    <label for="phone">
                        <i class="fas fa-phone"></i>
                        Telefone *
                    </label>
                    <input type="text" id="phone" name="phone" placeholder="(00) 00000-0000" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="musical_preference">
                    <i class="fas fa-music"></i>
                    Gosto Musical
                </label>
                <input type="text" id="musical_preference" name="musical_preference" 
                       placeholder="Ex: MPB, Rock, Cl√°ssica...">
            </div>
            
            <div class="form-group">
                <label for="observations">
                    <i class="fas fa-notes-medical"></i>
                    Observa√ß√µes
                </label>
                <textarea id="observations" name="observations" rows="4" 
                          placeholder="Informa√ß√µes adicionais sobre o paciente..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePatientModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPage = 1;
let searchTimeout;

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üè• Inicializando p√°gina de pacientes');
    loadPatients();
    
    // Configurar busca
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadPatients();
        }, 500);
    });
    
    // Configurar formul√°rio
    document.getElementById('patientForm').addEventListener('submit', handlePatientSubmit);
    
    // Configurar m√°scaras
    setupMasks();
    
    // Configurar valida√ß√µes em tempo real
    setupValidations();
});

// Carregar pacientes
async function loadPatients(page = 1) {
    console.log(`üìã Carregando pacientes - P√°gina ${page}`);
    const search = document.getElementById('searchInput').value;
    const url = `/patients/api/list?page=${page}&search=${encodeURIComponent(search)}`;
    
    try {
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Pacientes carregados:', data);
        
        renderPatients(data.patients);
        renderPagination(data);
        currentPage = page;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar pacientes:', error);
        showToast('Erro ao carregar pacientes: ' + error.message, 'error');
        
        // Mostrar mensagem de erro na tabela
        document.getElementById('patientsTableBody').innerHTML = 
            `<tr><td colspan="7" class="text-center" style="color: #f44336;">
                <i class="fas fa-exclamation-triangle"></i> 
                Erro ao carregar pacientes: ${error.message}
            </td></tr>`;
    }
}

// Renderizar tabela
function renderPatients(patients) {
    const tbody = document.getElementById('patientsTableBody');
    
    if (patients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center" style="color: #666;">
                    <i class="fas fa-user-friends" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                    Nenhum paciente encontrado
                </td>
            </tr>`;
        return;
    }
    
    tbody.innerHTML = patients.map(patient => {
        const createdDate = new Date(patient.created_at);
        let birthInfo = '<em>N√£o informado</em>';
        
        if (patient.birth_date) {
            const birthDate = new Date(patient.birth_date + 'T00:00:00');
            const age = calculateAge(birthDate);
            birthInfo = `${birthDate.toLocaleDateString('pt-BR')} <small>(${age} anos)</small>`;
        }
        
        return `
            <tr>
                <td><strong>${patient.full_name}</strong></td>
                <td><code>${patient.cpf}</code></td>
                <td>${birthInfo}</td>
                <td>${patient.phone}</td>
                <td>${patient.musical_preference || '<em>-</em>'}</td>
                <td>${createdDate.toLocaleDateString('pt-BR')}</td>
                <td>
                    <div class="action-buttons">
                        <a href="/atendimentos/novo?patient_id=${patient.id}" class="btn btn-sm btn-primary" title="Iniciar Atendimento">
                            <i class="fas fa-play"></i> Iniciar
                        </a>
                        <button class="btn-icon" onclick="viewPatient(${patient.id})" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editPatient(${patient.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon danger" onclick="deletePatient(${patient.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Renderizar pagina√ß√£o
function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    
    if (data.pages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Bot√£o anterior
    html += `<button onclick="loadPatients(${data.current_page - 1})" 
                    ${data.current_page === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;
    
    // P√°ginas
    const startPage = Math.max(1, data.current_page - 2);
    const endPage = Math.min(data.pages, data.current_page + 2);
    
    if (startPage > 1) {
        html += `<button onclick="loadPatients(1)">1</button>`;
        if (startPage > 2) html += `<span>...</span>`;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="loadPatients(${i})" 
                        class="${i === data.current_page ? 'active' : ''}">${i}</button>`;
    }
    
    if (endPage < data.pages) {
        if (endPage < data.pages - 1) html += `<span>...</span>`;
        html += `<button onclick="loadPatients(${data.pages})">${data.pages}</button>`;
    }
    
    // Bot√£o pr√≥ximo
    html += `<button onclick="loadPatients(${data.current_page + 1})" 
                    ${data.current_page === data.pages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;
    
    pagination.innerHTML = html;
}

// Modal functions
function openPatientModal() {
    console.log('‚ûï Abrindo modal para novo paciente');
    document.getElementById('modalTitle').textContent = 'Novo Paciente';
    document.getElementById('patientForm').reset();
    document.getElementById('patientId').value = '';
    document.getElementById('patientModal').classList.add('active');
    
    // Focar no primeiro campo
    setTimeout(() => {
        document.getElementById('full_name').focus();
    }, 300);
}

function closePatientModal() {
    document.getElementById('patientModal').classList.remove('active');
}

// Ver detalhes do paciente
function viewPatient(id) {
    // Por enquanto, abrir para edi√ß√£o
    editPatient(id);
}

// Editar paciente
async function editPatient(id) {
    console.log(`‚úèÔ∏è Editando paciente ID: ${id}`);
    
    try {
        const response = await fetch(`/patients/api/${id}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const patient = await response.json();
        console.log('‚úÖ Dados do paciente carregados:', patient);
        
        document.getElementById('modalTitle').textContent = 'Editar Paciente';
        document.getElementById('patientId').value = patient.id;
        document.getElementById('full_name').value = patient.full_name;
        document.getElementById('cpf').value = patient.cpf;
        document.getElementById('birth_date').value = patient.birth_date || '';
        document.getElementById('phone').value = patient.phone;
        document.getElementById('musical_preference').value = patient.musical_preference || '';
        document.getElementById('observations').value = patient.observations || '';
        
        document.getElementById('patientModal').classList.add('active');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados do paciente:', error);
        showToast('Erro ao carregar dados do paciente: ' + error.message, 'error');
    }
}

// Salvar paciente (criar ou editar)
async function handlePatientSubmit(e) {
    e.preventDefault();
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    // Mostrar loading
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const patientId = document.getElementById('patientId').value;
        const data = Object.fromEntries(formData);
        
        console.log('üíæ Salvando paciente:', data);
        
        // Validar dados antes de enviar
        const validation = validatePatientData(data);
        if (!validation.valid) {
            throw new Error(validation.message);
        }
        
        const url = patientId ? `/patients/api/${patientId}` : '/patients/api/create';
        const method = patientId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('‚úÖ Paciente salvo com sucesso:', result);
        showToast(result.message, 'success');
        closePatientModal();
        loadPatients(currentPage);
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar paciente:', error);
        showToast(error.message, 'error');
    } finally {
        // Restaurar bot√£o
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
}

// Excluir paciente
async function deletePatient(id) {
    const patient = await getPatientById(id);
    const patientName = patient ? patient.full_name : 'este paciente';
    
    if (!confirm(`Tem certeza que deseja excluir ${patientName}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
    }
    
    console.log(`üóëÔ∏è Excluindo paciente ID: ${id}`);
    
    try {
        const response = await fetch(`/patients/api/${id}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('‚úÖ Paciente exclu√≠do com sucesso');
        showToast(result.message, 'success');
        loadPatients(currentPage);
        
    } catch (error) {
        console.error('‚ùå Erro ao excluir paciente:', error);
        showToast('Erro ao excluir paciente: ' + error.message, 'error');
    }
}

// Buscar paciente por ID (auxiliar)
async function getPatientById(id) {
    try {
        const response = await fetch(`/patients/api/${id}`);
        return response.ok ? await response.json() : null;
    } catch {
        return null;
    }
}

// Configurar m√°scaras nos campos
function setupMasks() {
    // CPF com valida√ß√£o visual
    const cpfInput = document.getElementById('cpf');
    cpfInput.addEventListener('input', function(e) {
        maskCPF(e.target);
        validateCPFVisual(e.target);
    });
    
    // Telefone
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function(e) {
        maskPhone(e.target);
        validatePhoneVisual(e.target);
    });
}

// Configurar valida√ß√µes em tempo real
function setupValidations() {
    // Nome
    document.getElementById('full_name').addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value.length < 3) {
            showFieldError(e.target, 'Nome deve ter pelo menos 3 caracteres');
        } else {
            clearFieldError(e.target);
        }
    });
}

// Valida√ß√£o visual do CPF
function validateCPFVisual(input) {
    const isValid = validateCPF(input.value);
    if (input.value.length >= 11) {
        if (isValid) {
            input.style.borderColor = '#4caf50';
            clearFieldError(input);
        } else {
            input.style.borderColor = '#f44336';
            showFieldError(input, 'CPF inv√°lido');
        }
    } else {
        input.style.borderColor = '';
        clearFieldError(input);
    }
}

// Valida√ß√£o visual do telefone
function validatePhoneVisual(input) {
    const isValid = validatePhone(input.value);
    if (input.value.length >= 10) {
        if (isValid) {
            input.style.borderColor = '#4caf50';
            clearFieldError(input);
        } else {
            input.style.borderColor = '#f44336';
            showFieldError(input, 'Telefone inv√°lido');
        }
    } else {
        input.style.borderColor = '';
        clearFieldError(input);
    }
}

// Mostrar erro no campo
function showFieldError(input, message) {
    clearFieldError(input);
    const error = document.createElement('div');
    error.className = 'field-error';
    error.style.color = '#f44336';
    error.style.fontSize = '12px';
    error.style.marginTop = '4px';
    error.textContent = message;
    input.parentNode.appendChild(error);
}

// Limpar erro do campo
function clearFieldError(input) {
    const error = input.parentNode.querySelector('.field-error');
    if (error) error.remove();
}

// Validar dados do paciente antes do envio
function validatePatientData(data) {
    if (!data.full_name || data.full_name.trim().length < 3) {
        return { valid: false, message: 'Nome deve ter pelo menos 3 caracteres' };
    }
    
    if (!validateCPF(data.cpf)) {
        return { valid: false, message: 'CPF inv√°lido' };
    }
    
    if (!validatePhone(data.phone)) {
        return { valid: false, message: 'Telefone inv√°lido' };
    }
    
    // Validar data de nascimento apenas se fornecida
    if (data.birth_date) {
        const birthDate = new Date(data.birth_date);
        const today = new Date();
        if (birthDate > today) {
            return { valid: false, message: 'Data de nascimento n√£o pode ser futura' };
        }
        
        const age = calculateAge(birthDate);
        if (age > 120) {
            return { valid: false, message: 'Data de nascimento inv√°lida' };
        }
    }
    
    return { valid: true };
}

// Calcular idade
function calculateAge(birthDate) {
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    return age;
}

// Fechar modal ao clicar fora
document.getElementById('patientModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePatientModal();
    }
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // ESC para fechar modal
    if (e.key === 'Escape') {
        closePatientModal();
    }
    
    // Ctrl+N para novo paciente
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openPatientModal();
    }
});
</script>

<style>
/* Estilos espec√≠ficos para a p√°gina de pacientes */
.text-center {
    text-align: center;
}

.pagination span {
    padding: 8px 12px;
    color: #666;
}

.field-error {
    animation: shake 0.3s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Loading states */
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Success/Error visual feedback */
input.success {
    border-color: #4caf50 !important;
}

input.error {
    border-color: #f44336 !important;
}
</style>
{% endblock %}